<!DOCTYPE html>
<html>
<head>
  <title>Work Schedule - Digital Life Organizer</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
<div id="navArea"></div>

<div class="container page-wrap fade-in">
  <div class="section-title">
    <div>
      <h3>Work Schedule (Weekly Calendar)</h3>
      <div class="small-muted">Recurring weekly shifts for 4 months â€¢ Week 8 automatically skipped â€¢ Reminder if over 24h/week.</div>
    </div>

    <div class="d-flex gap-2 flex-wrap">
      <button class="btn btn-outline-dark btn-sm" onclick="prevWeek()">Prev Week</button>
      <button class="btn btn-outline-dark btn-sm" onclick="nextWeek()">Next Week</button>
      <button class="btn btn-outline-dark btn-sm" onclick="refreshAll()">Refresh</button>
    </div>
  </div>

  <div class="row g-3">
    <!-- LEFT: add recurring work template + list -->
    <div class="col-lg-5">
      <div class="card p-3 shadow-soft mb-3">
        <h5 class="fw-bold mb-2">Add Work Timetable (Repeats Weekly)</h5>

        <label class="form-label">Weekday</label>
        <select id="t_weekday" class="form-select mb-2">
          <option value="1">Monday</option><option value="2">Tuesday</option><option value="3">Wednesday</option>
          <option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option>
          <option value="7">Sunday</option>
        </select>

        <div class="row g-2">
          <div class="col">
            <label class="form-label">Start</label>
            <input id="t_start" type="time" class="form-control mb-2">
          </div>
          <div class="col">
            <label class="form-label">End</label>
            <input id="t_end" type="time" class="form-control mb-2">
          </div>
        </div>

        <label class="form-label">Workplace</label>
        <input id="t_workplace" class="form-control mb-2" placeholder="Optional">

        <label class="form-label">Role</label>
        <input id="t_role" class="form-control mb-2" placeholder="Optional">

        <label class="form-label">Term Start</label>
        <input id="t_start_date" type="date" class="form-control mb-2">

        <label class="form-label">Term End (4 months)</label>
        <input id="t_end_date" type="date" class="form-control mb-2">

        <label class="form-label">Notes</label>
        <input id="t_notes" class="form-control mb-3" placeholder="Optional">

        <div class="small-muted mb-2">Week 8 will be skipped automatically âœ…</div>

        <button class="btn btn-dark w-100" onclick="addTemplate()">Save Work Timetable</button>
      </div>

      <div class="card p-3 shadow-soft mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <b>This week total</b>
          <span class="kpi-pill" id="weekTotal">0h 0m</span>
        </div>
        <div class="small-muted mt-2" id="weekHint">Try to stay within 24h/week.</div>
      </div>

      <div class="card p-3 shadow-soft">
        <h5 class="fw-bold mb-2">My Work Templates</h5>
        <div id="tplList" class="text-muted">Loading...</div>
      </div>
    </div>

    <!-- RIGHT: weekly calendar -->
    <div class="col-lg-7">
      <div class="card p-3 shadow-soft">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="fw-bold mb-0" id="weekTitle">Week</h5>
          <span class="kpi-pill" id="weekRange">Range</span>
        </div>

        <hr class="my-3">

        <div id="calendar"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/ui.js"></script>
<script src="js/api.js"></script>
<script src="js/auth.js"></script>
<script src="js/navbar.js"></script>

<script>
  // Auth guard
  const token = localStorage.getItem("token");
  const user = getUser();
  if (!token || !user) window.location.href = "index.html";
  renderNavbar();

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function ymd(d){ return d.toISOString().slice(0,10); }

  function minsBetween(start, end) {
    const [sh, sm] = String(start).split(":");
    const [eh, em] = String(end).split(":");
    const s = (parseInt(sh||0)*60) + parseInt(sm||0);
    const e = (parseInt(eh||0)*60) + parseInt(em||0);
    let diff = e - s;
    if (diff <= 0) diff = (24*60 - s) + e; // overnight
    return diff;
  }
  function fmtHM(mins){
    const h = Math.floor(mins/60);
    const m = mins%60;
    return `${h}h ${m}m`;
  }

  // Monday of current week
  function mondayOf(d) {
    const x = new Date(d);
    const day = (x.getDay() + 6) % 7; // Mon=0
    x.setDate(x.getDate() - day);
    x.setHours(0,0,0,0);
    return x;
  }

  let weekStart = mondayOf(new Date()); // Date object

  function prevWeek(){
    weekStart = new Date(weekStart);
    weekStart.setDate(weekStart.getDate() - 7);
    refreshAll();
  }
  function nextWeek(){
    weekStart = new Date(weekStart);
    weekStart.setDate(weekStart.getDate() + 7);
    refreshAll();
  }

  async function refreshAll(){
    await loadTemplates();
    await loadWeekCalendar();
  }

  // ---------- Templates ----------
  async function loadTemplates(){
    const box = document.getElementById("tplList");
    box.textContent = "Loading...";
    try{
      const data = await apiRequest("/work-templates", "GET", null, true);
      const tpls = data.templates || [];
      const wd = ["","Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

      if(!tpls.length){
        box.innerHTML = "<div class='text-muted'>No templates yet.</div>";
        return;
      }

      box.innerHTML = tpls.map(t => `
        <div class="list-item">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <b>${escapeHtml(t.workplace || "Work")}</b>
              <div class="small-muted">${wd[t.weekday]} â€¢ ${t.start_time} - ${t.end_time}</div>
              ${t.role ? `<div class="small-muted">Role: ${escapeHtml(t.role)}</div>` : ``}
              <div class="small-muted">${t.start_date} â†’ ${t.end_date}</div>
              ${t.notes ? `<div class="small-muted">${escapeHtml(t.notes)}</div>` : ""}
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="delTemplate(${t.id})">Delete</button>
          </div>
        </div>
      `).join("");
    }catch(e){
      box.innerHTML = `<div class="text-danger">${escapeHtml(e.message)}</div>`;
    }
  }

  async function addTemplate(){
    const weekday = document.getElementById("t_weekday").value;
    const start_time = document.getElementById("t_start").value;
    const end_time = document.getElementById("t_end").value;
    const workplace = document.getElementById("t_workplace").value.trim();
    const role = document.getElementById("t_role").value.trim();
    const start_date = document.getElementById("t_start_date").value;
    const end_date = document.getElementById("t_end_date").value;
    const notes = document.getElementById("t_notes").value.trim();

    if(!weekday || !start_time || !end_time || !start_date || !end_date){
      return toast("Weekday, start/end time, term start/end required.", "error");
    }

    await apiRequest("/work-templates", "POST",
      { weekday, start_time, end_time, workplace, role, start_date, end_date, notes }, true);

    toast("Work timetable saved âœ…", "success");
    document.getElementById("t_start").value = "";
    document.getElementById("t_end").value = "";
    document.getElementById("t_workplace").value = "";
    document.getElementById("t_role").value = "";
    document.getElementById("t_notes").value = "";
    refreshAll();
  }

  async function delTemplate(id){
    if(!confirm("Delete this work template?")) return;
    await apiRequest(`/work-templates/${id}`, "DELETE", null, true);
    toast("Deleted ðŸ—‘ï¸", "info");
    refreshAll();
  }

  // ---------- Weekly Calendar ----------
  async function loadWeekCalendar(){
    const cal = document.getElementById("calendar");
    cal.innerHTML = "Loading...";

    const wsStr = ymd(weekStart);
    const we = new Date(weekStart);
    we.setDate(we.getDate() + 6);

    document.getElementById("weekTitle").textContent =
      `Week of ${weekStart.toLocaleDateString()}`;

    document.getElementById("weekRange").textContent =
      `${wsStr} â†’ ${ymd(we)}`;

    // fetch generated template events
    const gen = await apiRequest(`/work-templates/generate?weekStart=${wsStr}`, "GET", null, true);
    const events = gen.events || [];

    // map date -> events
    const map = {};
    for(const e of events){
      if(!map[e.date]) map[e.date] = [];
      map[e.date].push(e);
    }

    // weekly total + reminder
    let total = 0;
    for(const e of events){
      total += Math.max(0, minsBetween(e.start_time, e.end_time));
    }
    document.getElementById("weekTotal").textContent = fmtHM(total);

    const hint = document.getElementById("weekHint");
    if(total > 24*60){
      hint.innerHTML = `<span class="text-danger">Reminder: you worked ${escapeHtml(fmtHM(total))} this week (over 24h).</span>`;
    } else {
      hint.textContent = "Try to stay within 24h/week.";
    }

    // build 7-day grid
    const headers = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    let html = `
      <div class="d-grid" style="grid-template-columns: repeat(7, 1fr); gap: 10px;">
        ${headers.map(h=>`<div class="small-muted fw-bold">${h}</div>`).join("")}
    `;

    for(let i=0;i<7;i++){
      const d = new Date(weekStart);
      d.setDate(d.getDate() + i);
      const key = ymd(d);

      const items = (map[key] || []).sort((a,b)=>String(a.start_time).localeCompare(String(b.start_time)));

      html += `
        <div class="p-2 rounded-4 shadow-soft" style="min-height: 140px;">
          <div class="d-flex justify-content-between">
            <b>${d.getDate()}</b>
            <span class="small-muted">${key}</span>
          </div>

          <div class="mt-2" style="display:flex; flex-direction:column; gap:6px;">
            ${
              items.length
                ? items.map(it => `
                  <div class="badge text-bg-dark text-wrap" style="text-align:left;">
                    ${escapeHtml(it.start_time)}-${escapeHtml(it.end_time)}
                    â€¢ ${escapeHtml(it.workplace || "Work")}
                    ${it.role ? ` â€¢ ${escapeHtml(it.role)}` : ``}
                  </div>
                `).join("")
                : `<div class="small-muted">No shifts</div>`
            }
          </div>
        </div>
      `;
    }

    html += `</div>`;
    cal.innerHTML = html;
  }

  // Default term start & end (4 months)
  (function initDefaults(){
    const today = new Date();
    document.getElementById("t_start_date").value = ymd(today);
    const end = new Date(today);
    end.setMonth(end.getMonth() + 4);
    document.getElementById("t_end_date").value = ymd(end);
  })();

  refreshAll();
</script>
</body>
</html>
