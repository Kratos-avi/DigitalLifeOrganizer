<!DOCTYPE html>
<html>
<head>
  <title>Newcomer Dashboard - Digital Life Organizer</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div id="navArea"></div>

  <div class="container page-wrap fade-in">
    <div class="section-title">
      <div>
        <h3>Newcomer Dashboard</h3>
        <div class="small-muted">Your tasks checklist + quick progress.</div>
      </div>
      <button class="btn btn-outline-dark btn-sm" onclick="loadTasks()">Refresh</button>
    </div>

    <!-- ‚úÖ KPI Cards (Now 6) -->
    <div class="row g-3 mb-3">
      <!-- Pending -->
      <div class="col-md-4 col-lg-2">
        <div class="card p-3 shadow-soft">
          <div class="kpi">
            <div>
              <div class="kpi-title">Pending</div>
              <p class="kpi-value" id="pendingCount">-</p>
            </div>
            <span class="kpi-pill">To Do</span>
          </div>
        </div>
      </div>

      <!-- Completed -->
      <div class="col-md-4 col-lg-2">
        <div class="card p-3 shadow-soft">
          <div class="kpi">
            <div>
              <div class="kpi-title">Completed</div>
              <p class="kpi-value" id="doneCount">-</p>
            </div>
            <span class="kpi-pill">Done</span>
          </div>
        </div>
      </div>

      <!-- Upcoming deadlines -->
      <div class="col-md-4 col-lg-2">
        <div class="card p-3 shadow-soft">
          <div class="kpi">
            <div>
              <div class="kpi-title">Deadlines (7d)</div>
              <p class="kpi-value" id="kpiDeadlines7">-</p>
            </div>
            <span class="kpi-pill">Soon</span>
          </div>
        </div>
      </div>

      <!-- Work hours this week -->
      <div class="col-md-4 col-lg-2">
        <div class="card p-3 shadow-soft">
          <div class="kpi">
            <div>
              <div class="kpi-title">Work (week)</div>
              <p class="kpi-value" id="kpiWorkWeek">-</p>
            </div>
            <span class="kpi-pill">Hours</span>
          </div>
        </div>
      </div>

      <!-- Study hours this week -->
      <div class="col-md-4 col-lg-2">
        <div class="card p-3 shadow-soft">
          <div class="kpi">
            <div>
              <div class="kpi-title">Study (week)</div>
              <p class="kpi-value" id="kpiStudyWeek">-</p>
            </div>
            <span class="kpi-pill">Hours</span>
          </div>
        </div>
      </div>

      <!-- Tip -->
      <div class="col-md-4 col-lg-2">
        <div class="card p-3 shadow-soft">
          <div class="kpi">
            <div>
              <div class="kpi-title">Tip</div>
              <p class="mb-0 fw-bold" id="kpiTipTitle">Check Deadlines</p>
              <div class="small-muted" id="kpiTipBody">Stay ahead of important dates.</div>
            </div>
            <span class="kpi-pill">‚≠ê</span>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <!-- Add Task -->
      <div class="col-lg-5">
        <div class="card p-3 shadow-soft">
          <h5 class="mb-3 fw-bold">Add Task</h5>

          <label class="form-label">Title</label>
          <input id="title" class="form-control mb-2" placeholder="Example: Apply for SIN">

          <label class="form-label">Description</label>
          <textarea id="description" class="form-control mb-2" rows="3" placeholder="Optional details"></textarea>

          <label class="form-label">Due Date</label>
          <input id="due_date" type="date" class="form-control mb-3">

          <button class="btn btn-dark w-100" onclick="addTask()">Add Task</button>

          <div class="small-muted mt-2">
            Starter tasks may appear automatically for new users.
          </div>
        </div>
      </div>

      <!-- Task List -->
      <div class="col-lg-7">
        <div class="card p-3 shadow-soft">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h5 class="mb-0 fw-bold">My Tasks</h5>

            <div class="d-flex gap-2 flex-wrap">
              <input id="taskSearch" class="form-control form-control-sm glass-input"
                     placeholder="Search..." style="max-width: 180px;">
              <select id="taskStatus" class="form-select form-select-sm glass-input" style="max-width: 140px;">
                <option value="all" selected>All</option>
                <option value="pending">Pending</option>
                <option value="completed">Completed</option>
              </select>
            </div>
          </div>

          <hr class="my-3">

          <div id="taskList" class="text-muted">Loading...</div>

          <div class="d-flex justify-content-between align-items-center mt-3">
            <button id="btnPrev" class="btn btn-sm btn-outline-dark">Prev</button>
            <div class="small-muted" id="pageInfo">Page 1 / 1</div>
            <button id="btnNext" class="btn btn-sm btn-outline-dark">Next</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content card shadow-soft p-2">
        <div class="modal-header">
          <h5 class="modal-title">Edit Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="edit_id">

          <label class="form-label">Title</label>
          <input id="edit_title" class="form-control mb-2">

          <label class="form-label">Description</label>
          <textarea id="edit_description" class="form-control mb-2" rows="3"></textarea>

          <label class="form-label">Due Date</label>
          <input id="edit_due_date" type="date" class="form-control mb-2">

          <label class="form-label">Status</label>
          <select id="edit_status" class="form-select">
            <option value="pending">pending</option>
            <option value="completed">completed</option>
          </select>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-dark" onclick="saveEdit()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script src="js/ui.js"></script>
  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/navbar.js"></script>

  <script>
    // ---------- Auth guard ----------
    const token = localStorage.getItem("token");
    const user = getUser();
    if (!token || !user) window.location.href = "index.html";
    if (user.role !== "newcomer") window.location.href = "admin.html";

    renderNavbar();

    // ---------- Helpers ----------
    function notify(msg, type = "info") {
      if (typeof toast === "function") return toast(msg, type);
      alert(msg);
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function formatDate(d) {
      try { return new Date(d).toLocaleDateString(); }
      catch { return d; }
    }

    function minsBetween(start, end) {
      const [sh, sm] = String(start).split(":");
      const [eh, em] = String(end).split(":");
      const s = (parseInt(sh||0)*60) + parseInt(sm||0);
      const e = (parseInt(eh||0)*60) + parseInt(em||0);
      let diff = e - s;
      if (diff <= 0) diff = (24*60 - s) + e;
      return diff;
    }

    function fmtHM(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return `${h}h ${m}m`;
    }

    // Monday of current week
    function mondayOf(d) {
      const x = new Date(d);
      const day = (x.getDay() + 6) % 7;
      x.setDate(x.getDate() - day);
      x.setHours(0,0,0,0);
      return x;
    }
    function ymd(d){ return d.toISOString().slice(0,10); }

    // Safe base64 encode/decode
    function toB64(obj) {
      return btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
    }
    function fromB64(b64) {
      return JSON.parse(decodeURIComponent(escape(atob(b64))));
    }

    // ---------- State ----------
    let state = { q: "", status: "all", page: 1, limit: 6, totalPages: 1 };

    // ---------- UI Events ----------
    document.getElementById("taskSearch").addEventListener("input", (e) => {
      state.q = e.target.value || "";
      state.page = 1;
      loadTasks();
    });

    document.getElementById("taskStatus").addEventListener("change", (e) => {
      state.status = e.target.value || "all";
      state.page = 1;
      loadTasks();
    });

    document.getElementById("btnPrev").addEventListener("click", () => {
      if (state.page > 1) {
        state.page--;
        loadTasks();
      }
    });

    document.getElementById("btnNext").addEventListener("click", () => {
      if (state.page < state.totalPages) {
        state.page++;
        loadTasks();
      }
    });

    // ---------- KPI Loaders ----------
    async function loadSummary() {
      const data = await apiRequest("/tasks/summary", "GET", null, true);
      document.getElementById("pendingCount").textContent = data.pending ?? 0;
      document.getElementById("doneCount").textContent = data.completed ?? 0;
    }

    async function loadDeadlinesKpi() {
      try {
        const data = await apiRequest("/deadlines", "GET", null, true);
        const deadlines = data.deadlines || [];

        const today = new Date();
        today.setHours(0,0,0,0);

        const in7 = new Date(today);
        in7.setDate(in7.getDate() + 7);

        const upcoming = deadlines.filter(d => {
          if (!d.due_date) return false;
          const dd = new Date(String(d.due_date).slice(0,10) + "T00:00:00");
          return dd >= today && dd <= in7 && d.status !== "done";
        });

        document.getElementById("kpiDeadlines7").textContent = upcoming.length;

        if (upcoming.length > 0) {
          document.getElementById("kpiTipTitle").textContent = "Deadline soon";
          document.getElementById("kpiTipBody").textContent = "You have deadlines in the next 7 days.";
        }
      } catch {
        document.getElementById("kpiDeadlines7").textContent = "-";
      }
    }

    async function loadWorkWeekKpi() {
      try {
        const ws = mondayOf(new Date());
        const wsStr = ymd(ws);

        const gen = await apiRequest(`/work-templates/generate?weekStart=${wsStr}`, "GET", null, true);
        const events = gen.events || [];

        let total = 0;
        for (const e of events) total += Math.max(0, minsBetween(e.start_time, e.end_time));

        document.getElementById("kpiWorkWeek").textContent = fmtHM(total);

        if (total > 24*60) {
          document.getElementById("kpiTipTitle").textContent = "Work hours high";
          document.getElementById("kpiTipBody").textContent = "You are over 24h this week. Be careful.";
        }
      } catch {
        document.getElementById("kpiWorkWeek").textContent = "-";
      }
    }

    async function loadStudyWeekKpi() {
      try {
        // We generate for current month then filter to this week range
        const today = new Date();
        const month = String(today.getMonth()+1).padStart(2,"0");
        const monthStr = `${today.getFullYear()}-${month}`;

        const gen = await apiRequest(`/study-templates/generate?month=${monthStr}`, "GET", null, true);
        const events = gen.events || [];

        const ws = mondayOf(new Date());
        const we = new Date(ws);
        we.setDate(we.getDate() + 6);

        const wsKey = ymd(ws);
        const weKey = ymd(we);

        let total = 0;
        for (const e of events) {
          if (e.date >= wsKey && e.date <= weKey) {
            total += Math.max(0, minsBetween(e.start_time, e.end_time));
          }
        }

        document.getElementById("kpiStudyWeek").textContent = fmtHM(total);

        if (total < 10*60) {
          document.getElementById("kpiTipTitle").textContent = "Study reminder";
          document.getElementById("kpiTipBody").textContent = "Try to reach 10h+ study this week.";
        }
      } catch {
        document.getElementById("kpiStudyWeek").textContent = "-";
      }
    }

    async function loadAllKpis() {
      await Promise.all([
        loadSummary(),
        loadDeadlinesKpi(),
        loadWorkWeekKpi(),
        loadStudyWeekKpi()
      ]);
    }

    // ---------- Tasks ----------
    async function loadTasks() {
      const list = document.getElementById("taskList");
      list.textContent = "Loading...";

      try {
        await loadAllKpis();

        const qs = new URLSearchParams({
          q: state.q,
          status: state.status,
          page: String(state.page),
          limit: String(state.limit),
        });

        const data = await apiRequest("/tasks?" + qs.toString(), "GET", null, true);

        state.totalPages = data.totalPages || 1;

        document.getElementById("pageInfo").textContent = `Page ${data.page} / ${state.totalPages}`;
        document.getElementById("btnPrev").disabled = (data.page <= 1);
        document.getElementById("btnNext").disabled = (data.page >= state.totalPages);

        if (!data.tasks || !data.tasks.length) {
          list.innerHTML = "<p class='text-muted mb-0'>No tasks found.</p>";
          return;
        }

        list.innerHTML = data.tasks.map(t => {
          const status = (t.status || "pending");
          const isCompleted = status === "completed";

          return `
            <div class="list-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="d-flex gap-2 align-items-center">
                    <b>${escapeHtml(t.title)}</b>
                    ${t.is_starter == 1 ? `<span class="badge text-bg-info">starter</span>` : ``}
                  </div>

                  ${t.description ? `<div class="small-muted">${escapeHtml(t.description)}</div>` : ""}

                  <div class="small mt-1">
                    <b>Due:</b> ${t.due_date ? formatDate(t.due_date) : "Not set"}
                  </div>
                </div>

                <span class="badge ${isCompleted ? "text-bg-success" : "text-bg-secondary"}">
                  ${escapeHtml(status)}
                </span>
              </div>

              <div class="list-actions mt-2 d-flex gap-2 flex-wrap">
                <button class="btn btn-sm btn-outline-primary"
                        onclick="openEditB64('${toB64(t)}')">Edit</button>

                <button class="btn btn-sm btn-outline-success"
                        ${isCompleted ? "disabled" : ""}
                        onclick="markDone(${t.id})">
                  Mark Done
                </button>

                <button class="btn btn-sm btn-outline-danger"
                        onclick="deleteTask(${t.id})">
                  Delete
                </button>
              </div>
            </div>
          `;
        }).join("");

      } catch (e) {
        list.innerHTML = `<p class="text-danger mb-0">${escapeHtml(e.message)}</p>`;
      }
    }

    async function addTask() {
      const title = document.getElementById("title").value.trim();
      const description = document.getElementById("description").value.trim();
      const due_date = document.getElementById("due_date").value || null;

      if (!title) return notify("Title is required!", "error");

      try {
        await apiRequest("/tasks", "POST", { title, description, due_date }, true);

        document.getElementById("title").value = "";
        document.getElementById("description").value = "";
        document.getElementById("due_date").value = "";

        notify("Task added ‚úÖ", "success");
        loadTasks();
      } catch (e) {
        notify(e.message, "error");
      }
    }

    async function markDone(id) {
      try {
        await apiRequest(`/tasks/${id}`, "PUT", { status: "completed" }, true);
        notify("Marked completed ‚úÖ", "success");
        loadTasks();
      } catch (e) {
        notify(e.message, "error");
      }
    }

    async function deleteTask(id) {
      if (!confirm("Delete this task?")) return;
      try {
        await apiRequest(`/tasks/${id}`, "DELETE", null, true);
        notify("Task deleted üóëÔ∏è", "info");
        loadTasks();
      } catch (e) {
        notify(e.message, "error");
      }
    }

    // ---------- Edit Modal ----------
    function openEditB64(b64) {
      const t = fromB64(b64);

      document.getElementById("edit_id").value = t.id;
      document.getElementById("edit_title").value = t.title || "";
      document.getElementById("edit_description").value = t.description || "";
      document.getElementById("edit_due_date").value = t.due_date ? String(t.due_date).slice(0, 10) : "";
      document.getElementById("edit_status").value = (t.status || "pending");

      const modal = new bootstrap.Modal(document.getElementById("editTaskModal"));
      modal.show();
    }

    async function saveEdit() {
      const id = document.getElementById("edit_id").value;
      const title = document.getElementById("edit_title").value.trim();
      const description = document.getElementById("edit_description").value.trim();
      const due_date = document.getElementById("edit_due_date").value || null;
      const status = document.getElementById("edit_status").value;

      if (!title) return notify("Title is required!", "error");

      try {
        await apiRequest(`/tasks/${id}`, "PUT", { title, description, due_date, status }, true);
        notify("Task updated ‚úÖ", "success");

        const inst = bootstrap.Modal.getInstance(document.getElementById("editTaskModal"));
        if (inst) inst.hide();

        loadTasks();
      } catch (e) {
        notify(e.message, "error");
      }
    }

    // ---------- Init ----------
    loadTasks();
  </script>
</body>
</html>
