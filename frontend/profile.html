<!DOCTYPE html>
<html>
<head>
  <title>Profile - Digital Life Organizer</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div id="navArea"></div>

  <div class="container page-wrap fade-in">
    <div class="section-title">
      <div>
        <h3>My Profile</h3>
        <div class="small-muted">Update your name and change password securely.</div>
      </div>
    </div>

    <div class="row g-3">
      <!-- Profile Card -->
      <div class="col-lg-6">
        <div class="card p-3 shadow-soft">
          <h5 class="fw-bold mb-3">Profile Info</h5>

          <div class="small-muted mb-2">Email</div>
          <div class="mb-3 fw-bold" id="emailBox">-</div>

          <label class="form-label">Full Name</label>
          <input id="full_name" class="form-control mb-3" placeholder="Your name">

          <div class="small-muted mb-2">Role</div>
          <div class="mb-3 fw-bold" id="roleBox">-</div>

          <button class="btn btn-dark w-100" onclick="saveProfile()">Save Profile</button>
        </div>
      </div>

      <!-- Change Password Card -->
      <div class="col-lg-6">
        <div class="card p-3 shadow-soft">
          <h5 class="fw-bold mb-3">Change Password</h5>

          <label class="form-label">Current Password</label>
          <input id="currentPassword" type="password" class="form-control mb-2" placeholder="••••••••">

          <label class="form-label">New Password</label>
          <input id="newPassword" type="password" class="form-control mb-3" placeholder="Minimum 6 characters">

          <button class="btn btn-outline-dark w-100" onclick="changePassword()">Update Password</button>

          <div class="small-muted mt-2">
            Tip: Don’t reuse old passwords.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script src="js/ui.js"></script>
  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/navbar.js"></script>

  <script>
    const token = localStorage.getItem("token");
    const u = getUser();
    if (!token || !u) window.location.href = "index.html";

    renderNavbar();

    async function loadProfile() {
      try {
        const data = await apiRequest("/profile/me", "GET", null, true);
        document.getElementById("emailBox").textContent = data.user.email;
        document.getElementById("roleBox").textContent = data.user.role;
        document.getElementById("full_name").value = data.user.full_name || "";
      } catch (e) {
        toast(e.message, "error");
      }
    }

    async function saveProfile() {
      const full_name = document.getElementById("full_name").value.trim();
      if (!full_name) return toast("Full name is required", "error");

      try {
        await apiRequest("/profile/me", "PUT", { full_name }, true);

        // update localStorage user object too
        const userObj = getUser();
        userObj.full_name = full_name;
        localStorage.setItem("user", JSON.stringify(userObj));

        toast("Profile updated ✅", "success");
      } catch (e) {
        toast(e.message, "error");
      }
    }

    async function changePassword() {
      const currentPassword = document.getElementById("currentPassword").value;
      const newPassword = document.getElementById("newPassword").value;

      if (!currentPassword || !newPassword) return toast("Both fields are required", "error");

      try {
        await apiRequest("/profile/change-password", "PUT", { currentPassword, newPassword }, true);
        document.getElementById("currentPassword").value = "";
        document.getElementById("newPassword").value = "";
        toast("Password updated ✅", "success");
      } catch (e) {
        toast(e.message, "error");
      }
    }

    loadProfile();
  </script>
</body>
</html>
